<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowerfolk Chronicles - Feedback</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base font */
        body {
            font-family: 'Inter', sans-serif;
            /* A soft, natural background color inspired by the logo's theme */
            background-color: #F8FBF0; 
        }

        /* --- Custom Theme Colors --- */
        /* Extracted from the logo */
        .theme-orange { color: #E98A2A; }
        .theme-teal { color: #2BB09E; }
        .bg-theme-orange { background-color: #E98A2A; }
        .bg-theme-teal { background-color: #2BB09E; }
        .border-theme-orange { border-color: #E98A2A; }
        .border-theme-teal { border-color: #2BB09E; }
        .hover\:bg-theme-orange-dark:hover { background-color: #D4771B; }
        .hover\:bg-theme-teal-dark:hover { background-color: #208F7F; }
        
        /* --- Star Rating System --- */
        .star-rating {
            display: flex;
            flex-direction: row-reverse; /* This makes the hover effect work correctly */
            justify-content: center;
        }

        .star-rating input[type="radio"] {
            display: none;
        }

        .star-rating label {
            font-size: 2.5rem; /* Large, easy-to-tap stars */
            color: #D1D5DB; /* gray-300 */
            cursor: pointer;
            padding: 0 0.25rem;
        }

        /* Hover effect: colors stars from the one you're hovering on to the left */
        .star-rating:not(:hover) input[type="radio"]:checked ~ label,
        .star-rating:hover input[type="radio"] ~ label:hover,
        .star-rating:hover input[type="radio"] ~ label:hover ~ label {
            color: #F59E0B; /* amber-500 */
        }
        
        /* Selected star color (when not hovering) */
        .star-rating input[type="radio"]:checked ~ label {
            color: #F59E0B; /* amber-500 */
        }

        /* --- Flower Pop Animation (UPDATED) --- */
        #animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 100;
            pointer-events: none; /* Allow clicks through */
            overflow: hidden; /* Hide flowers that fly off-screen */
        }

        #animation-overlay.show {
            display: flex;
        }

        /* The flower SVG */
        .flower-pop {
            position: absolute;
            opacity: 0;
            transform: scale(0);
            will-change: transform, opacity;
            /* JS will set top, left, width, height, and animation vars */
        }

        /* The animation keyframes */
        @keyframes pop-and-float {
            0% {
                opacity: 0.8;
                /* Use CSS variables set by JS for unique animations */
                transform: scale(0.3) rotate(var(--start-rot, 0deg));
            }
            40% {
                opacity: 1;
                transform: scale(1.1) rotate(var(--mid-rot, 15deg));
            }
            100% {
                opacity: 0;
                transform: scale(0.5) rotate(var(--end-rot, -10deg)) translateY(-200vh); /* Float high off-screen */
            }
        }
        
        /* Class added by JS to trigger the animation */
        .flower-pop.animate {
            /* JS will set animation-delay */
            animation: pop-and-float 1.6s cubic-bezier(0.17, 0.89, 0.32, 1.28) forwards;
        }

        /* --- Custom Modal (for errors/success) --- */
        #message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: flex-start; /* Show at top */
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 110;
            padding-top: 5rem;
        }
        
        #message-modal.show {
            display: flex;
        }

        #message-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header with Logo -->
    <header class="container mx-auto px-4 py-8 flex justify-center">
        <!-- Logo Image from upload -->
        <img 
            src="https://storage.googleapis.com/genai-canvas-uploads/Untitled406_20251112214015.jpg-583b5a6a-2413-4573-b739-974928ffd293" 
            alt="Flowerfolk Chronicles Logo" 
            class="w-full max-w-lg rounded-lg"
            onerror="this.style.display='none'; document.getElementById('logo-fallback').classList.remove('hidden');"
        >
        <!-- Fallback text if image fails -->
        <h1 id="logo-fallback" class="hidden text-5xl font-bold text-center theme-orange" style="font-family: 'Comic Sans MS', cursive, sans-serif;">
            Flowerfolk Chronicles
        </h1>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-2 gap-12">

        <!-- Left Column: Feedback Form -->
        <section class="w-full max-w-lg mx-auto md:max-w-none md:mx-0">
            <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-3xl font-bold text-center mb-6 theme-teal">Leave Your Feedback!</h2>
                <p class="text-center text-gray-600 mb-6">
                    Let us know what you think! You can pick a name or get a random one.
                </p>

                <form id="feedback-form" class="space-y-6">
                    <!-- Name Input -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Your Name (Optional)</label>
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="name" 
                                name="name" 
                                placeholder="e.g., Sunny Petal"
                                class="flex-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-theme-teal focus:ring-theme-teal"
                            >
                            <button 
                                type="button" 
                                id="random-name-btn"
                                class="px-3 py-2 bg-theme-teal text-white rounded-lg shadow-sm hover:bg-theme-teal-dark transition-colors text-sm font-medium"
                            >
                                Random
                            </button>
                        </div>
                    </div>

                    <!-- Review Textarea -->
                    <div>
                        <label for="review" class="block text-sm font-medium text-gray-700 mb-1">Review or Suggestion</label>
                        <textarea 
                            id="review" 
                            name="review" 
                            rows="5" 
                            placeholder="What did you like? What could be better?" 
                            required
                            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-theme-teal focus:ring-theme-teal"
                        ></textarea>
                    </div>

                    <!-- Star Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2 text-center">Your Rating</label>
                        <div class="star-rating">
                            <input type="radio" id="star5" name="rating" value="5" required><label for="star5" title="5 stars">★</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">★</label>
                            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">★</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">★</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">★</label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        type="submit" 
                        id="submit-btn"
                        class="w-full px-6 py-3 bg-theme-orange text-white text-lg font-semibold rounded-lg shadow-md hover:bg-theme-orange-dark transition-all transform hover:scale-105"
                    >
                        Submit Review
                    </button>
                </form>
            </div>
        </section>

        <!-- Right Column: Display Reviews -->
        <section>
            <h2 class="text-3xl font-bold text-center mb-6 theme-orange">What Readers Are Saying</h2>
            
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center items-center h-48">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-theme-teal"></div>
            </div>
            
            <!-- No Reviews Message -->
            <p id="no-reviews-message" class="text-center text-gray-500 hidden">
                Be the first to leave a review!
            </p>

            <!-- Reviews Container -->
            <div id="reviews-container" class="space-y-4">
                <!-- Reviews will be dynamically inserted here -->
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="text-center py-10 mt-12 border-t border-gray-200">
        <p class="text-sm text-gray-500">
            To contact us privately, send a message to <strong class="theme-teal">eren_is_pro_835</strong> 
            or <strong class="theme-teal">levi_aint_pro_57757</strong> in Discord.
        </p>
    </footer>

    <!-- Animation Overlay (UPDATED with new SVGs) -->
    <div id="animation-overlay">
        <!-- New Flower SVGs (x5) -->
        
        <!-- Flower 1: Orange/Pink -->
        <svg class="flower-pop" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="grad-orange">
                    <stop offset="0%" stop-color="#F4A261" />
                    <stop offset="100%" stop-color="#E76F51" />
                </radialGradient>
                <filter id="shadow-sm">
                    <feDropShadow dx="1" dy="1" stdDeviation="1" flood-color="#000000" flood-opacity="0.2"/>
                </filter>
            </defs>
            <g style="filter: url(#shadow-sm);">
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(0 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(60 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(120 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(180 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(240 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(300 50 50)"/>
            </g>
            <circle cx="50" cy="50" r="15" fill="#FDF4A3" />
            <circle cx="50" cy="50" r="12" fill="#FDE047" />
        </svg>

        <!-- Flower 2: Teal -->
        <svg class="flower-pop" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="grad-teal-2">
                    <stop offset="0%" stop-color="#58CDBF" />
                    <stop offset="100%" stop-color="#2BB09E" />
                </radialGradient>
            </defs>
            <g style="filter: url(#shadow-sm);">
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(0 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(72 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(144 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(216 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(288 50 50)"/>
            </g>
            <circle cx="50" cy="50" r="12" fill="#FDF4A3" />
        </svg>
        
        <!-- Flower 3: Orange/Pink -->
        <svg class="flower-pop" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g style="filter: url(#shadow-sm);">
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(0 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(60 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(120 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(180 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(240 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(300 50 50)"/>
            </g>
            <circle cx="50" cy="50" r="15" fill="#FDF4A3" />
            <circle cx="50" cy="50" r="12" fill="#FDE047" />
        </svg>

        <!-- Flower 4: Teal -->
        <svg class="flower-pop" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g style="filter: url(#shadow-sm);">
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(0 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(72 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(144 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(216 50 50)"/>
                <ellipse cx="50" cy="30" rx="14" ry="14" fill="url(#grad-teal-2)" transform="rotate(288 50 50)"/>
            </g>
            <circle cx="50" cy="50" r="12" fill="#FDF4A3" />
        </svg>
        
        <!-- Flower 5: Orange/Pink -->
        <svg class="flower-pop" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g style="filter: url(#shadow-sm);">
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(0 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(60 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(120 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(180 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(240 50 50)"/>
                <ellipse cx="50" cy="30" rx="12" ry="18" fill="url(#grad-orange)" transform="rotate(300 50 50)"/>
            </g>
            <circle cx="50" cy="50" r="15" fill="#FDF4A3" />
            <circle cx="50" cy="50" r="12" fill="#FDE047" />
        </svg>

    </div>

    <!-- Message Modal -->
    <div id="message-modal">
        <div id="message-modal-content">
            <p id="modal-text" class="text-lg font-medium mb-4"></p>
            <button id="modal-close-btn" class="px-4 py-2 bg-theme-teal text-white rounded-lg">
                OK
            </button>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            Timestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIG (DO NOT EDIT) ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Firebase Initialization ---
        let app, auth, db;
        let userId = null;
        let reviewsUnsubscribe = null; // To stop listener on auth change
        
        // --- Firestore Collection Path ---
        const reviewsColPath = `artifacts/${appId}/public/data/reviews`;

        // --- DOM Elements ---
        const form = document.getElementById('feedback-form');
        const nameInput = document.getElementById('name');
        const reviewInput = document.getElementById('review');
        const randomNameBtn = document.getElementById('random-name-btn');
        const submitBtn = document.getElementById('submit-btn');
        const reviewsContainer = document.getElementById('reviews-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noReviewsMessage = document.getElementById('no-reviews-message');
        const animationOverlay = document.getElementById('animation-overlay');
        const messageModal = document.getElementById('message-modal');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Random Name Generation ---
        const ADJECTIVES = [
            "Sunny", "Gentle", "Whimsy", "Bright", "Tiny", "Quick", "Calm", "Happy",
            "Forest", "River", "Dewy", "Verdant", "Blossom"
        ];
        const NOUNS = [
            "Petal", "Sprout", "Bloom", "Root", "Seedling", "Leaf", "Vine", "Thorn",
            "Bud", "Flower", "Folk", "Sprite", "Stem"
        ];

        function generateRandomName() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            return `${adj} ${noun}`;
        }

        randomNameBtn.addEventListener('click', () => {
            nameInput.value = generateRandomName();
        });

        // --- Modal Controls ---
        function showModal(message) {
            modalText.textContent = message;
            messageModal.classList.add('show');
        }

        modalCloseBtn.addEventListener('click', () => {
            messageModal.classList.remove('show');
        });

        // --- Animation Control (UPDATED) ---
        function playFlowerAnimation() {
            const flowers = document.querySelectorAll('.flower-pop');
            animationOverlay.classList.add('show');

            flowers.forEach(flower => {
                // Randomize position, size, and rotation
                const size = Math.random() * 60 + 60; // size between 60px and 120px
                
                // Center the burst area at the bottom of the screen
                const viewportWidth = window.innerWidth;
                const burstCenterX = viewportWidth / 2;
                
                // Randomize horizontal position within a small central range (10% left/right of center)
                const randomOffset = (Math.random() - 0.5) * viewportWidth * 0.2; // -10% to +10%
                const x = burstCenterX + randomOffset;
                
                // Start position just off the bottom edge
                const y = window.innerHeight + 10; 

                const startRot = Math.random() * 180 - 90; // -90 to 90 deg
                const midRot = startRot + (Math.random() * 30 - 15);
                const endRot = midRot + (Math.random() * 60 - 30);
                const delay = Math.random() * 0.5; // up to 0.5s delay

                // Apply styles
                flower.style.width = `${size}px`;
                flower.style.height = `${size}px`;
                // Use fixed positions for the pop origin
                flower.style.left = `${x}px`;
                flower.style.top = `${y}px`;
                
                // Set CSS variables for the keyframes
                flower.style.setProperty('--start-rot', `${startRot}deg`);
                flower.style.setProperty('--mid-rot', `${midRot}deg`);
                flower.style.setProperty('--end-rot', `${endRot}deg`);

                flower.style.animationDelay = `${delay}s`;

                // Add class to trigger animation
                flower.classList.add('animate');

                // Remove class after animation to reset
                // 1.6s animation + 0.5s max delay + 0.1s buffer
                setTimeout(() => {
                    flower.classList.remove('animate');
                }, 2200); 
            });
            
            // Hide the overlay after all animations are done
            setTimeout(() => {
                animationOverlay.classList.remove('show');
            }, 2200); // Match the longest timeout
        }

        // --- Render Functions ---
        function createStarRatingDisplay(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += `<span class="text-amber-500">★</span>`;
                } else {
                    stars += `<span class="text-gray-300">★</span>`;
                }
            }
            return `<div class="flex">${stars}</div>`;
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'Just now';
            return timestamp.toDate().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function renderReview(doc) {
            const review = doc.data();
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-lg shadow border border-gray-100 transform transition-transform duration-300';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-bold text-lg theme-teal">${review.name || 'Anonymous'}</h4>
                        <span class="text-xs text-gray-400">${formatDate(review.createdAt)}</span>
                    </div>
                    ${createStarRatingDisplay(review.rating)}
                </div>
                <p class="text-gray-700 whitespace-pre-wrap">${review.review}</p>
            `;
            // Prepend new reviews to the top
            reviewsContainer.prepend(card);
        }

        // --- Fetch Reviews (Real-time) ---
        function fetchReviews() {
            if (reviewsUnsubscribe) reviewsUnsubscribe(); // Stop previous listener
            if (!db) return;

            const q = query(collection(db, reviewsColPath));
            
            reviewsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                loadingSpinner.style.display = 'none'; // Hide spinner
                
                if (querySnapshot.empty) {
                    noReviewsMessage.classList.remove('hidden');
                    reviewsContainer.innerHTML = ''; // Clear just in case
                } else {
                    noReviewsMessage.classList.add('hidden');
                }

                // Handle updates efficiently
                querySnapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        renderReview(change.doc);
                    }
                    // Can add 'modified' and 'removed' handlers if needed
                });

            }, (error) => {
                console.error("Error fetching reviews: ", error);
                loadingSpinner.style.display = 'none';
                showModal("Could not load reviews. Please try refreshing.");
            });
        }

        // --- Form Submission ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            
            // Validation
            if (!reviewInput.value) {
                showModal('Please write a review or suggestion.');
                return;
            }
            if (!ratingInput) {
                showModal('Please select a star rating.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            let currentName = nameInput.value.trim();
            if (!currentName) {
                currentName = generateRandomName();
            }

            try {
                // Save to Firestore
                await addDoc(collection(db, reviewsColPath), {
                    name: currentName,
                    review: reviewInput.value,
                    rating: parseInt(ratingInput.value, 10),
                    createdAt: Timestamp.now(),
                    submitterId: userId // Store userId (even if anonymous)
                });

                // Success!
                playFlowerAnimation();
                form.reset(); // Clear the form
                nameInput.value = ''; // Ensure name is cleared

            } catch (error) {
                console.error("Error adding document: ", error);
                showModal('There was an error submitting your review. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Review';
            }
        });

        // --- Main App Initialization ---
        async function initialize() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable Firebase logs
                
                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('User is signed in:', user.uid);
                        userId = user.uid;
                        // User is ready, fetch data
                        fetchReviews();
                    } else {
                        console.log('User is signed out.');
                        userId = null;
                        if (reviewsUnsubscribe) reviewsUnsubscribe(); // Stop listening
                        reviewsContainer.innerHTML = ''; // Clear reviews
                        loadingSpinner.style.display = 'none';
                        noReviewsMessage.classList.remove('hidden');
                        noReviewsMessage.textContent = 'Please sign in to see reviews.'; // Or just hide
                    }
                });

                // Sign in the user
                if (initialAuthToken) {
                    console.log('Signing in with custom token...');
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log('No token, signing in anonymously...');
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error initializing Firebase: ", error);
                loadingSpinner.style.display = 'none';
                noReviewsMessage.classList.remove('hidden');
                noReviewsMessage.textContent = 'Could not connect to services.';
            }
        }

        // Start the application
        initialize();

    </script>

</body>
</html>